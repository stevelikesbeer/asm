FormatMessageA PROTO,
                dwFlags:DWORD,
                lpSource:DWORD,
                dwMsgID:DWORD,
                dwLanguageID:DWORD,
                lpBuffer:PTR BYTE,
                nSize:DWORD,
                va_list:DWORD

GetLastError   PROTO
LocalFree   PROTO,
                hMem:DWORD

; Receives: nothing
; Returns: nothing
.code
WriteWindowsMsg PROC USES eax edx
        .data
            WriteWindowsMsg_1 BYTE "Error ",0
            WriteWindowsMsg_2 BYTE ": ",0
            pErrorMsg DWORD ? ; points to error message
            messageId DWORD ?
        .code
            call GetLastError
            mov messageId,eax
            ; Display the error number.
            mov edx,OFFSET WriteWindowsMsg_1
            call WriteString
            call WriteDec
            mov edx,OFFSET WriteWindowsMsg_2

            call WriteString
            ; Get the corresponding message string.
            INVOKE FormatMessageA, 100h + 1000h, 0, messageID, 0, ADDR pErrorMsg, 0, 0
            ; Display the error message generated by MS-Windows.
            mov edx,pErrorMsg
            call WriteString
            ; Free the error message string.
            INVOKE LocalFree, pErrorMsg
            ret
WriteWindowsMsg ENDP